<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Puck.js SpOâ‚‚ + Pressure Dashboard</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      display: flex;
      align-items: center;
    }
    .spo2 {
      font-size: 3em;
      font-weight: bold;
      margin-right: 50px;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 20px;
    }
    .box {
      background: #222;
      padding: 40px;
      text-align: center;
      border-radius: 15px;
      font-size: 2em;
      min-width: 100px;
    }
    .connect-btn {
      position: absolute;
      bottom: 30px;
      padding: 10px 20px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spo2">
      SpO<sub>2</sub><br><span id="spo2">--%</span>
    </div>
    <div class="grid">
      <div class="box" id="p1">0.00</div>
      <div class="box" id="p2">0.00</div>
      <div class="box" id="p3">0.00</div>
      <div class="box" id="p4">0.00</div>
    </div>
  </div>
  <button class="connect-btn" onclick="connect()">Connect to Puck.js</button>

  <script>
    let gatt;
    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "Puck.js" }],
          optionalServices: [0x180f]
        });
        gatt = await device.gatt.connect();

        const service = await gatt.getPrimaryService(0x180f);
        const char = await service.getCharacteristic(0x2a19);

        await char.startNotifications();
        char.addEventListener("characteristicvaluechanged", event => {
          const val = new TextDecoder().decode(event.target.value);
          try {
            const json = JSON.parse(val);
            document.getElementById("spo2").textContent = json.spo2 + "%";
            const [p1, p2, p3, p4] = json.pressures;
            document.getElementById("p1").textContent = p1.toFixed(2);
            document.getElementById("p2").textContent = p2.toFixed(2);
            document.getElementById("p3").textContent = p3.toFixed(2);
            document.getElementById("p4").textContent = p4.toFixed(2);
          } catch (e) {
            console.log("Parse error:", e, val);
          }
        });
      } catch (err) {
        alert("Connection error: " + err);
      }
    }
  </script>
</body>
</html>
