<!DOCTYPE html>
<html>
<head>
  <title>Pressure Quadrants</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: sans-serif;
    }

    #grid {
      display: grid;
      grid-template-columns: 150px 150px;
      grid-template-rows: 150px 150px;
      gap: 10px;
      margin-top: 30px;
    }

    .quadrant {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      font-weight: bold;
      background-color: #ccc;
      border-radius: 10px;
      transition: background-color 0.3s;
    }

    .flash {
      animation: flash 0.6s infinite alternate;
    }

    @keyframes flash {
      0% { background-color: red; }
      100% { background-color: #ff8080; }
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Force Sensor Visualization</h1>
  <button onclick="connect()">Connect to Puck.js</button>

  <div id="grid">
    <div class="quadrant" id="q0">0.00</div>
    <div class="quadrant" id="q1">0.00</div>
    <div class="quadrant" id="q2">0.00</div>
    <div class="quadrant" id="q3">0.00</div>
  </div>

  <script>
    let bluetoothDevice, nusService, rxCharacteristic;

    function setQuadrantColor(el, value) {
      el.classList.remove("flash");

      if (value <= 0.3) {
        el.style.backgroundColor = "green";
      } else if (value <= 0.7) {
        el.style.backgroundColor = "yellow";
      } else if (value <= 0.9) {
        el.style.backgroundColor = "red";
      } else {
        el.classList.add("flash");
      }
    }

    function handleData(data) {
      const readings = data.trim().split(',').map(parseFloat);
      readings.forEach((val, idx) => {
        const el = document.getElementById("q" + idx);
        if (el) {
          el.textContent = val.toFixed(2);
          setQuadrantColor(el, val);
        }
      });
    }

    async function connect() {
      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'Puck.js' }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] // Nordic UART Service
        });

        const server = await bluetoothDevice.gatt.connect();
        nusService = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        rxCharacteristic = await nusService.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        await rxCharacteristic.startNotifications();
        rxCharacteristic.addEventListener('characteristicvaluechanged', event => {
          const value = new TextDecoder().decode(event.target.value);
          handleData(value);
        });

        alert("Connected to Puck.js!");
      } catch (error) {
        console.error(error);
        alert("Failed to connect: " + error.message);
      }
    }
  </script>
</body>
</html>
