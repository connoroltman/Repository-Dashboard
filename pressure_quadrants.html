<!DOCTYPE html>
<html>
<head>
  <title>Vitals Dashboard</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    h1 { margin-top: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 120px); gap: 15px; justify-content: center; margin-top: 20px; }
    .cell { background: #fff; border-radius: 8px; padding: 30px; font-size: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    button { padding: 10px 20px; font-size: 16px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>SpO<sub>2</sub>: <span id="spo2">--</span>%</h1>
  <div class="grid">
    <div class="cell" id="p0">0.00</div>
    <div class="cell" id="p1">0.00</div>
    <div class="cell" id="p2">0.00</div>
    <div class="cell" id="p3">0.00</div>
  </div>
  <button onclick="connect()">Connect to Puck.js</button>

  <script>
    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'Puck.js' }],
          optionalServices: [0x180F] // Battery service (required for Web Bluetooth)
        });

        const server = await device.gatt.connect();
        const uartService = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        const rxChar = await uartService.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");

        await rxChar.startNotifications();
        rxChar.addEventListener('characteristicvaluechanged', event => {
          const value = new TextDecoder().decode(event.target.value);
          try {
            const data = JSON.parse(value);
            document.getElementById("spo2").textContent = data.spo2;
            data.pressures.forEach((p, i) => {
              document.getElementById(`p${i}`).textContent = p.toFixed(2);
            });
          } catch (e) {
            console.warn("Invalid data:", value);
          }
        });
      } catch (e) {
        alert("Connection error: " + e);
        console.error(e);
      }
    }
  </script>
</body>
</html>
