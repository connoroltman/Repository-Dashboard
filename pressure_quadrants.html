<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Puck.js Sensor Dashboard</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f4f4f4; }
    .spo2 { font-size: 2em; margin: 20px 0; }
    .pressure-grid { display: grid; grid-template-columns: repeat(2, 100px); gap: 20px; justify-content: center; }
    .pressure-box { background: #333; color: #fff; font-size: 1.5em; padding: 20px; border-radius: 10px; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 1em; }
  </style>
</head>
<body>
  <h1>SpO<sub>2</sub>: <span id="spo2">--</span>%</h1>
  <div class="pressure-grid">
    <div class="pressure-box" id="p0">0.00</div>
    <div class="pressure-box" id="p1">0.00</div>
    <div class="pressure-box" id="p2">0.00</div>
    <div class="pressure-box" id="p3">0.00</div>
  </div>
  <button onclick="connect()">Connect to Puck.js</button>

  <script>
    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'Puck.js' }],
          optionalServices: [0x180f]  // Generic service to satisfy requirement
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(0x180f); // Dummy service
        const tx = await service.getCharacteristic(0x2a19); // Dummy characteristic

        // Use Nordic UART fallback
        const uart = await device.gatt.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        const rx = await uart.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        await rx.startNotifications();
        rx.addEventListener('characteristicvaluechanged', event => {
          const val = new TextDecoder().decode(event.target.value);
          try {
            const data = JSON.parse(val);
            document.getElementById("spo2").textContent = data.spo2;
            data.pressures.forEach((v, i) => {
              document.getElementById("p" + i).textContent = v.toFixed(2);
            });
          } catch (e) {
            console.error("Parse error:", e);
          }
        });
      } catch (e) {
        alert("Connection error: " + e.message);
      }
    }
  </script>
</body>
</html>
